<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Guardian Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .card { background-color: #1e293b; border-radius: 0.5rem; padding: 1.5rem; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #38bdf8; }
        .stat-label { color: #94a3b8; font-size: 0.875rem; }
        .record-badge { background-color: #f59e0b; color: #000; font-weight: bold; padding: 0.1rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-white">üõ°Ô∏è Ollama Guardian</h1>
                <p class="text-slate-400">VRAM Scheduler & Optimization Suite</p>
            </div>
            <div class="flex gap-4">
                <div class="text-right">
                    <div class="text-sm text-slate-400">Status</div>
                    <div class="text-green-400 font-bold">ACTIVE</div>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card">
                <div class="stat-label">VRAM Usage</div>
                <div class="stat-value" id="vram-usage">--%</div>
                <div class="text-sm text-slate-500 mt-1" id="vram-detail">-- / -- MB</div>
            </div>
            <div class="card">
                <div class="stat-label">Active Models</div>
                <div class="stat-value" id="active-models">0</div>
                <div class="text-sm text-slate-500 mt-1" id="active-list">None</div>
            </div>
            <div class="card">
                <div class="stat-label">Queue Size</div>
                <div class="stat-value" id="queue-size">0</div>
            </div>
            <div class="card">
                <div class="stat-label">Optimized Requests</div>
                <div class="stat-value" id="optimized-count">0</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Active Combos -->
            <div class="card lg:col-span-2">
                <h2 class="text-xl font-bold mb-4 text-white">üé∞ Active Combo Cache</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="text-slate-400 border-b border-slate-700">
                            <tr>
                                <th class="pb-2">Model</th>
                                <th class="pb-2">Size (MB)</th>
                                <th class="pb-2">Last Used</th>
                                <th class="pb-2">Status</th>
                            </tr>
                        </thead>
                        <tbody id="combo-table" class="text-slate-300">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Benchmark Records -->
            <div class="card">
                <h2 class="text-xl font-bold mb-4 text-white">üèÜ Optimization Records</h2>
                <div class="space-y-4" id="records-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Benchmarks -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <div class="card lg:col-span-3">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <h2 class="text-xl font-bold mb-1 text-white">üìä Benchmarks</h2>
                        <div class="text-sm text-slate-400" id="benchmark-meta">Loading benchmark status‚Ä¶</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">
                    <div class="lg:col-span-1">
                        <div class="text-sm text-slate-400 mb-2">Best TPS per model</div>
                        <canvas id="benchmark-chart" height="180"></canvas>
                    </div>
                    <div class="lg:col-span-2">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="text-slate-400 border-b border-slate-700">
                                    <tr>
                                        <th class="pb-2">Model</th>
                                        <th class="pb-2">Best TPS</th>
                                        <th class="pb-2">Ctx</th>
                                        <th class="pb-2">Batch</th>
                                        <th class="pb-2">Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody id="benchmark-table" class="text-slate-300">
                                    <tr><td colspan="5" class="py-3 text-center text-slate-500">Loading‚Ä¶</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let benchmarkChart = null;

        function formatIso(ts) {
            if (!ts) return '‚Äî';
            const d = new Date(ts);
            if (isNaN(d.getTime())) return String(ts);
            return d.toLocaleString();
        }

        function upsertBenchmarkChart(models, tpsValues) {
            const ctx = document.getElementById('benchmark-chart').getContext('2d');
            const data = {
                labels: models,
                datasets: [{
                    label: 'Best TPS',
                    data: tpsValues,
                    backgroundColor: 'rgba(245, 158, 11, 0.6)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    borderWidth: 1,
                }]
            };

            if (benchmarkChart) {
                benchmarkChart.data = data;
                benchmarkChart.update();
                return;
            }

            benchmarkChart = new Chart(ctx, {
                type: 'bar',
                data,
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148, 163, 184, 0.1)' } },
                    }
                }
            });
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/stats'); 
                const data = await response.json();
                
                // Update VRAM
                const vramPercent = Math.round((data.vram.used / data.vram.total) * 100);
                document.getElementById('vram-usage').textContent = `${vramPercent}%`;
                document.getElementById('vram-detail').textContent = `${data.vram.used} / ${data.vram.total} MB`;
                
                // Update Active Models
                document.getElementById('active-models').textContent = data.active_models.length;
                document.getElementById('active-list').textContent = data.active_models.join(', ') || 'None';
                
                // Update Queue
                document.getElementById('queue-size').textContent = data.queue_size;

                // Update Optimized Count (Mock for now if not in API)
                document.getElementById('optimized-count').textContent = data.optimized_count || 0;
                
                // Update Combo Table
                const tbody = document.getElementById('combo-table');
                tbody.innerHTML = '';
                if (data.cached_models && data.cached_models.length > 0) {
                    data.cached_models.forEach(model => {
                        const row = `
                            <tr class="border-b border-slate-800 last:border-0">
                                <td class="py-3 font-medium text-white">${model.name}</td>
                                <td class="py-3">${model.size_mb} MB</td>
                                <td class="py-3">${new Date(model.last_used * 1000).toLocaleTimeString()}</td>
                                <td class="py-3"><span class="px-2 py-1 rounded bg-green-900 text-green-300 text-xs">CACHED</span></td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="py-3 text-center text-slate-500">No models in cache</td></tr>';
                }

                // Update Records List
                const recordsList = document.getElementById('records-list');
                recordsList.innerHTML = '';
                if (data.records && data.records.length > 0) {
                    data.records.forEach(record => {
                        const item = `
                            <div class="flex justify-between items-center border-b border-slate-800 pb-2 last:border-0">
                                <div>
                                    <div class="font-bold text-white">${record.model}</div>
                                    <div class="text-xs text-slate-400">${record.config}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-bold text-yellow-400">${record.tps.toFixed(1)} TPS</div>
                                    <div class="text-xs text-green-400">+${record.improvement}%</div>
                                </div>
                            </div>
                        `;
                        recordsList.innerHTML += item;
                    });
                } else {
                    recordsList.innerHTML = '<div class="text-center text-slate-500">No records yet</div>';
                }

            } catch (e) {
                console.error("Failed to fetch stats", e);
            }
        }

        async function updateBenchmarks() {
            try {
                const response = await fetch('/api/benchmark');
                const data = await response.json();

                const meta = document.getElementById('benchmark-meta');
                const last = data.last_completed;
                const stateUpdated = data.state_mtime_iso ? formatIso(data.state_mtime_iso) : '‚Äî';
                if (last && last.timestamp) {
                    meta.textContent = `Last completed: ${formatIso(last.timestamp)} ‚Ä¢ Completed: ${data.completed_count} ‚Ä¢ Queue: ${data.queue_count} ‚Ä¢ State updated: ${stateUpdated}`;
                } else {
                    meta.textContent = `No completed benchmarks yet ‚Ä¢ Completed: ${data.completed_count} ‚Ä¢ Queue: ${data.queue_count} ‚Ä¢ State updated: ${stateUpdated}`;
                }

                const tbody = document.getElementById('benchmark-table');
                tbody.innerHTML = '';

                const best = Array.isArray(data.best_by_model) ? data.best_by_model : [];
                if (best.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="py-3 text-center text-slate-500">No benchmark results yet</td></tr>';
                    upsertBenchmarkChart([], []);
                    return;
                }

                const chartModels = [];
                const chartTps = [];

                best.slice(0, 10).forEach(row => {
                    const model = row.model || '‚Äî';
                    const tps = typeof row.best_tps === 'number' ? row.best_tps : 0;
                    chartModels.push(model);
                    chartTps.push(Number(tps.toFixed(2)));

                    const tr = `
                        <tr class="border-b border-slate-800 last:border-0">
                            <td class="py-3 font-medium text-white">${model}</td>
                            <td class="py-3 text-yellow-400 font-bold">${tps.toFixed(2)}</td>
                            <td class="py-3">${row.ctx ?? '‚Äî'}</td>
                            <td class="py-3">${row.batch ?? '‚Äî'}</td>
                            <td class="py-3">${formatIso(row.timestamp)}</td>
                        </tr>
                    `;
                    tbody.innerHTML += tr;
                });

                upsertBenchmarkChart(chartModels, chartTps);
            } catch (e) {
                console.error('Failed to fetch benchmark summary', e);
                const meta = document.getElementById('benchmark-meta');
                meta.textContent = 'Failed to load benchmark status';
            }
        }

        // Poll every 2 seconds
        setInterval(updateStats, 2000);
        updateStats(); // Initial call

        // Benchmarks change slower; refresh every 10 seconds
        setInterval(updateBenchmarks, 10000);
        updateBenchmarks();
    </script>
</body>
</html>
